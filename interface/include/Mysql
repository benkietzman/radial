// -*- C++ -*-
// Radial
// -------------------------------------
// file       : Mysql
// author     : Ben Kietzman
// begin      : 2022-04-21
// copyright  : Ben Kietzman
// email      : ben@kietzman.org
#ifndef _RADIAL_MYSQL_
#define _RADIAL_MYSQL_
// {{{ includes
#include <mysql/mysql.h>
#include "Interface"
// }}}
extern "C++"
{
namespace radial
{
// {{{ structs
struct radial_mysql_request
{
  bool bQuery;
  bool bResult;
  int fdPipe;
  size_t unSize;
  string strDatabase;
  string strError;
  string strHandle;
  string strPassword;
  string strQuery;
  string strServer;
  string strUser;
  unsigned int unPort;
  unsigned long long ullID;
  unsigned long long ullRows;
  Json *ptResults;
};
struct radial_mysql_connection
{
  bool bClose;
  bool bIdle;
  int fdPipe[2];
  mutex mutexConnection;
  queue<radial_mysql_request *> requests;
  thread *pThread;
  time_t CTime;
};
// }}} 
// {{{ Mysql
class Mysql : public Interface
{
  protected:
  int m_fdPipe[2];
  mutex m_mutexPipe;
  mutex m_mutexRequests;
  queue<radial_mysql_request *> m_requests;
  thread *m_pThreadRequests;

  void connection(string strPrefix, radial_mysql_connection *ptConnection);
  map<string, string> *fetch(MYSQL_RES *result, vector<string> subFields);
  bool fields(MYSQL_RES *result, vector<string> &subFields);
  void free(MYSQL_RES *result);
  void requests(string strPrefix);
  MYSQL_RES *query(MYSQL *conn, const string strQuery, unsigned long long &ullRows, string &strError);
  bool update(MYSQL *conn, const string strQuery, unsigned long long &ullID, unsigned long long &ullRows, string &strError);

  public:
  Mysql(string strPrefix, int argc, char **argv, void (*pCallback)(string, const string, const bool));
  ~Mysql();
  void callback(string strPrefix, const string strPacket, const bool bResponse);
};
// }}}
}
}
#endif
